# Chapter 11 Odoo 12 Development of Kanban View and User-side QWeb

This article is the eleventh in the series of [The best free ERP system Odoo 12 development manual](README.md).

QWeb is the template engine used by Odoo, which generates HTML snippets and pages based on XML. QWeb can be used to generate content-rich Kankan views, reports, and CMS web pages. In this article, we will learn the QWeb syntax and how to use QWeb to create our own Kankan views and custom reports.

The main contents of this article are:

- What is Kanban?
- Design the Kanban view
- QWeb template language
- Inheritance of Kanban View
- Add custom CSS and JavaScript



## Development Preparation

We will continue to use the library_checkout plugin module completed in Chapter 10 [Odoo 12 Development Background View - Design User Interface](10.md). The corresponding code can be found in the [GitHub repository](source-code/chapter10). The completed code of this chapter can also be found in the [GitHub repository](source-code/chapter11).

## Understood sign

Kanban is a Japanese word, literally meaning list, associated with lean manufacturing and just-in-time production, and introduced by Toyota industrial engineer Taiichi Ohno. Recently, the concept of Kanban has been applied to more fields and has become popular in the software industry with the implementation of agile methods.

Kanban boards allow us to visualize the work queue, organized in columns, where each column represents a stage in the work process. Work items are represented by cards placed in the corresponding columns of the Kanban board. New work items start in the leftmost column and start moving to the right until they reach the rightmost column, representing the completion of the work.

The simplicity or visual effect of Kanban makes it an excellent support for simple business processes. A basic Kanban example contains three columns, as shown below: To Do, In Progress, and Done. Of course, it can be expanded to other specific processes as you need:

![Kanban example](http://alanhou.org/homepage/wp-content/uploads/2019/01/kanban-example.jpg)

For many business use cases, Kanban is a more efficient way to manage the corresponding process, in stark contrast to the heavier workflow engine before Odoo 11. Odoo supports Kanban views in addition to the classic list and form views, which makes it easy to implement this type of view. Let's learn how to use the Kanban view.

### Board View

Now we are going to add a board view for the loan model. Each loan is a card and the board will be organized into stages. In the previous article, we have already added the stage_id stage field.

Previously, in form views, we mostly used Odoo-specific XML elements, such as <field> and <group>, and sometimes used HTML elements, such as <h1> or <div>, but they were used less frequently. In the kanban view, it is the opposite. The display template is based on HTML and only supports two Odoo-specific elements: <field> and <button>.

The content that is ultimately rendered in the web client is dynamically generated by QWeb templates. The QWeb engine processes special XML tags and attributes to generate it. This gives you a lot of control over how the content is rendered, but it also makes the view design more complex. Kanban view design is very flexible, and we will try to introduce the knowledge of quickly creating Kanban views in a straightforward and easy-to-understand way. It is a good idea to look at Kanban views similar to what you need to get ideas and then create your own Kanban board.

We will learn two ways to use the kanban view. One is a card list, which is used for contacts, products, employee directories, or applications. The contact kanban view looks like this:

![Odoo 12 Contacts Card View](http://alanhou.org/homepage/wp-content/uploads/2019/01/contacts-card.jpg)

But this is not a real Kanban board. A Kanban board is a card organized into different columns. Of course, the Kanban view also supports this layout. You can see examples in the CRM or Project app. Go to CRM > Sales > My Pipeline and you will get the following result:

![Odoo 12 CRM dashboard view](http://alanhou.org/homepage/wp-content/uploads/2019/01/crm-pipeline.jpg)

The biggest difference between the two layouts is how the cards are organized into columns. This is done with the Group By feature, similar to the list view. Usually the grouping is done with the stage field. A very useful feature of the Kanban view is that you can drag and drop cards between columns, automatically assigning the corresponding value of the grouping view field. We can see some differences from the cards in the two examples. In fact, their design is very flexible, and there is not only one way to design Kanban cards. These two examples provide us with some basics for design.

The basic structure of the contact card is an image on the left, a bold title in the main area, and a series of values ​​following it. The CRM pipeline card is a bit more complex. The main area of ​​the card also has a title followed by relevant information, and a footer area. In this area, you can see a priority component on the left, followed by an activity indicator, and an avatar of the responsible user on the right. Not visible in the image above, there is also an options menu when you hover over the top right corner. This menu allows us to change the color of the card, etc.

We will use this more complex structure as a reference for borrowing Kanban cards.

## Designing the Kanban View

We will improve the library_checkout model that we have been developing and add a kanban view for book borrowing. To do this we will use a new file library_checkout/views/checkout_kanban_view.xml. This file needs to be added at the bottom of the data key in the __manifest__.py file. In the library_checkout/views/library_menu.xml file, you can see the window actions used by the borrowing menu item. It needs to be modified to enable the view type added in this article:

```
    <act_window id="action_library_checkout"
        name="Checkouts"
        res_model="library.checkout"
        view_mode="kanban,tree,form,activity,calendar,graph,pivot" />
```

Here we have modified the menu action to add kanban at the top of the view_mode list, making it the default view mode. Then we add the kanban view record. It is basically the same as other views, except that in the arch field, the outermost XML element is <kanban>. The next step is to create the actual XML file library_checkout/views/checkout_kanban_view.xml to hold this amazing kanban view:

```
<?xml version="1.0"?>
<odoo>
    <record id="library_checkout_kanban" model="ir.ui.view">
        <field name="model">library.checkout</field>
        <field name="arch" type="xml">
            <kanban>

            </kanban>
        </field>
    </record>
</odoo>
```

Before using the kanban view, we need to add a few fields to the book loan model.

### Priority, Board Status, and Color

In addition to the stage, there are some common and useful fields in the Kanban board:

- priority allows users to organize their work items and mark what should be processed first
- kanban_state marks whether it should move to the next stage or stay where it is for some reason. Both are select fields in the model definition layer. In the view layer, there are special components for them for form and kanban views.
- color is used to store the color of the board card display and can be set through the color picker menu in the board view

Edit the library_checkout/models/library_checkout.py file to add these fields to our model:

```
class Checkout(models.Model):
...
    priority = fields.Selection(
        [('0', 'Low'),
        ('1', 'Normal'),
        ('2', 'High')],
        'Priority',
        default='1')
    kanban_state = fields.Selection(
        [('normal', 'In Progress'),
        ('blocked', 'Blocked'),
        ('done', 'Ready for next stage')],
        'Kanban State',
        default='normal')
```

We should also add these fields in the form view, using their own special widgets. The kanban_state field should be added just before the <div class="oe_title"> and after the button box: <field name="kanban_state" widget="state_selection" />. The priority field should be added before the name field, wrapped in an <h1> element: <field name="priority" widget="priority" />. The color field should not normally appear in the form view.

Now that the borrow model has all the fields we need to use, we can write the kanban view.

### Kanban Card Elements

The kanban view framework consists of a <kanban> outer element and the following basic structure:

```
<kanban default_group_by="stage_id" class="o_kanban_small_column">
                <!-- Fields -->
                <field name="stage_id" />
                <field name="id" />
                <field name="color" />
                <field name="kanban_state" />
                <field name="priority" />
                <field name="message_partner_ids" />

                <!-- Optional progress bar -->
                <progressbar
                    field="kanban_state"
                    colors='{"done": "success", "blocked": "danger"}' />
                <!-- Templates with HTML snippets to use -->
                <templates>
                    <t t-name="kanban-box">
                        <!-- HTML Qweb template -->
                    </t>
                </template>
            </kanban>
```

Note the use of the default_group_by="stage_id" attribute in the element. We use it to group the board by stage by default, which is also the usual way to group boards. In a simple card list board, such as a contact, we do not need to add this attribute and can just use the <kanban> tag. The <kanban> element supports the following attributes:

- default_group_by sets the field used for default column grouping
- default_order sets the default order used for kanban items
- quick_create="false" disables the quick create option (big plus sign) at the top of each column, which allows you to create new items by simply providing a title description. false is JavaScript syntax and must be lowercase.
- class为渲染看板视图的根元素添加 CSS 类。相关类是_kanban_small_column，让列比默认的更加紧湊。其它类可由我们模块的 CSS 文件来进行提供。
- group_create, group_edit, group_delete and quick_create_view can be set to false to disable the corresponding operations on the dashboard column. For example, group_create="false" removes the button on the right to add a new column.
- on_create is used to create a custom simple form view window that pops up when the user clicks the Create button in the upper left corner. The <module>.<xml_id> value should be added for the corresponding form view.

Then we have a set of fields used in our template. Specifically, only fields that are explicitly used in QWeb expressions need to be declared here to ensure that their data is fetched from the server. The QWeb engine only looks for <field name="..."> in the view to get data from the model before processing the template. QWeb attributes usually use record.field references which are not detected. Because of this, it is necessary to include these fields before <templates> so that the corresponding field values ​​are available when the template is processed.

> ℹ️ **Changes in Odoo 11**
> Introduced a progress bar component. When used, a color bar will appear above the dashboard column to provide status data for each item in the column. You can see this in the example diagram of CRM Pipeline earlier in this article.

<progressbar> has the following attributes:

- field is the name of the field for color grouping of items in the column
- colors is a dictionary mapping the grouping field values ​​to one of three colors: danger (red), warning (yellow), or success (green).
- sum_field is an optional field name to be used to summarize the entire column. If not set, the count value of each item will be used.

Our <templates> element then contains one or more QWeb templates to generate the HTML snippets to use. There must be a template called kanban-box, which renders the kanban card. Other templates can also be added, usually to define HTML snippets that are reused in the main template. These templates use standard HTML and the QWeb template language. QWeb provides some special instructions for handling the dynamic generation of the final displayed HTML.

> ℹ️ **Changes in Odoo 12**
> Odoo now uses Twitter Bootstrap 4, previously using Bootstrap 3. These styles are generally available wherever HTML is rendered, for more information on Bootstrap, see the [official website](https://getbootstrap.com/).

Let’s take a closer look at the QWeb template design used in the Kanban view.

### Kanban Card Layout

The main content area of ​​the kanban card is defined in the kanban-box template. This content area can also have a footer bottom child container. A button can also be added to the top right corner of the card to open the action menu function when clicked. For the footer area, a <div> should be used at the bottom of the kanban box template and the oe_kanban_bottom CSS class should be added. It can also be further divided into left and right footer areas using the oe_kanban_bottom_left and oe_kanban_bottom_right CSS classes. In addition, Bootstrap's pull-left and pull-right classes can be used to add left or right aligned elements anywhere in the card (including the oe_kanban_bottom bottom area).

Here is the first iteration of the QWeb template for the Kanban card:

```
                    <t t-name="kanban-box">
                        <!-- Set the Kanban Card color -->
                        <div t-attf-class="
                            oe_kanban_color_#{kanban_getcolor(record.color.raw_value)}
                            oe_kanban_global_click">
                            <div class="o_dropdown_kanban dropdown">
                                <!-- Top-right drop down menu here... -->
                            </div>
                            <div class="oe_kanban_body">
                                <!-- Content elements and fields go here... -->
                            </div>
                            <div class="oe_kanban_footer">
                                <div class="oe_kanban_footer_left">
                                    <!-- Left hand footer... -->
                                </div>
                                <div class="oe_kanban_footer_right">
                                    <!-- Right hand footer... -->
                                </div>
                            </div>
                            <div class="oe_clear" />
                        </div>
                    </t>
```

This is the overall structure of a Kanban card. You may have noticed that the color field is used in the top <div> element to dynamically set the card color. We will go into the details of the t-attf QWeb directive in the following sections. Now let's add content to the main content area:

```
                            <div class="oe_kanban_body">
                                <div>
                                    <strong>
                                        <a type="open"><field name="member_id" /></a>
                                    </strong>
                                </div>
                                <ul>
                                    <li><field name="user_id" /></li>
                                    <li><field name="request_date" /></li>
                                </ul>
                            </div>
```

Most of this template is regular HTML, but there are also <field> elements that render the field value and the type attribute used in regular form view buttons, which is used here in the anchor tag.

Insert the priority component into the left footer:

```
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="priority" widget="priority" />
                                    <field name="activity_ids" widget="kanban_activity" />
                                </div>
...
                            </div>
```

Here we add the priority field as we did in the form view. We also add a field for scheduled activities and use the kanban_activity special component to show an indication of the upcoming activity.

In the right footer, place the board status component and the member avatar requesting to borrow the item:

```
                                <div class="oe_kanban_bottom_right">
                                    <field name="kanban_state"
                                        widget="kanban_state_selection" />
                                    <img t-att-src="kanban_image(
                                            'library.checkout',
                                            'member_image',
                                            record.id.raw_value)"
                                        t-att-title="record.member_id.value"
                                        t-att-alt="record.member_id.value"
                                        width="24"
                                        height="24"
                                        class="oe_kanban_avatar"
                                    />
                                </div>
```

Supplement: The CSS classes oe_kanban_footer, oe_kanban_footer_left and oe_kanban_footer_right used in the original file were tested and did not align left and right. The above modifications were made according to CRM.

The board states are added using the <field> element and the kanban_state_selection component. User avatars are inserted using the HTML <img> tag. The image content is dynamically generated using the QWeb t-att- command, which will be explained in detail later. The kanban_image() helper function is used here to get the value of the src attribute. The kanban_image() Javascript function gets the form from the Odoo model and renders it on the web page. It has the following properties:

- Get the model of the image
- Field containing the image
- The ID of the record to be obtained

![Odoo 12 Kanban footer added](http://alanhou.org/homepage/wp-content/uploads/2019/01/kanban-footer.jpg)

### Add options menu for kanban cards

Kanban cards can have an options menu in the top right corner. Common actions are to edit or delete a record, but you can also add buttons to them to call the same actions. There is also a component to set the card color. Here is the basic code for the options menu added at the top of oe_kanban_content:

```
                            <div class="o_dropdown_kanban dropdown">
                                <a class="dropdown-toggle btn"
                                    data-toggle="dropdown" role="button"
                                    aria-label="Dropdown menu"
                                    title="Dropdown menu"
                                    href="#">
                                    <span class="fa fa-ellipsis-v" />
                                </a>
                                <div class="dropdown-menu" role="menu">
                                    <!-- Edit and Delete actions, if available: -->
                                    <t t-if="widget.editable">
                                        <a role="menuitem" type="edit" class="dropdown-item">Edit</a>
                                    </t>
                                    <t t-if="widget.deletable">
                                        <a role="menuitem" type="delete" class="dropdown-item">Delete</a>
                                    </t>
                                    <!-- Color picker option -->
                                    <ul class="oe_kanban_colorpicker" data-field="color" />
                                </div>
                            </div>
```

A drop-down menu is basically a list element with an <li> HTML element inside an <a> tag. Options like Edit and Delete appear only when certain conditions are met. This is done with QWeb's t-if command. QWeb commands are explained in detail later in this article. The widget global variable represents a KanbanRecord() JS object that is responsible for rendering the current Kanban card. There are two very useful properties: widget.editable and widget.deletable, which allow us to check if the corresponding operation is available.

You can see how to show or hide options based on the record field value, Set as Done will only be shown if the is_done field is not set. The last option adds a color picker component to select or modify the card background color using the color data field. So, in addition to the <button> element, <a> can also be used to run Odoo actions.

![Odoo 12 Kanban view drop-down options](http://alanhou.org/homepage/wp-content/uploads/2019/01/kanban-dropdown.jpg)

### Operations in the Kanban View

In QWeb templates, <a> tags used for hyperlinks can have a type attribute. This sets the type of action the link performs, so that links can perform the same actions as buttons in regular forms. As with form views, the action type can be either action or object, and should have a name attribute to identify the specific action to be performed. In addition, the following action types can be used:

- open opens the corresponding form view
- edit directly opens the corresponding form view in edit mode
- delete Deletes the record and removes the item from the kanban view

## QWeb Template Language

QWeb looks for special directives in the template and replaces them with dynamically generated HTML. These directives are XML element attributes that can be used in valid tags or elements such as <div>, <span> or <field>. Sometimes we want to use QWeb directives but don't want to put them in the XML elements of the template. For this case, you can use the special element <t> that can carry QWeb directives (such as t-if or t-foreach), which will not have any output in the final generated XML/HTML.

QWeb commands often use expressions to generate different results depending on the current record value. There are two different QWeb implementations: client-side JavaScript and server-side Python. Reports and web pages use the server-side QWeb Python implementation. Dashboard views use client-side JavaScript. This means that QWeb expressions in kanban views should be written in JavaScript syntax, not Python.

When displaying the Kanban view, the internal steps are roughly as follows:

1. Get the template XML for rendering
2. Call the server-side read() method to obtain the field data involved in the template
3. Locate the kanban-boxs template and parse it using QWeb to output the final HTML snippet
4. Injecting HTML into the browser display (DOM)

The above is not technically accurate, it is just a mind map for understanding how things work in the Kanban view. Next we will learn how QWeb expressions work and explore the available QWeb commands to improve the borrowing Kanban card through examples.

### QWeb JavaScript execution context

Many QWeb commands use expressions to generate results. In client-side applications such as kanban views, expressions should be written in JavaScript. Expressions are evaluated in a context with several useful variables. A record object is available representing the current record with the fields requested from the server. Field values ​​can be retrieved via the raw_value or value attributes:

- raw_value is the value returned by the server read() method, so it is more suitable in conditional expressions
- The value is formatted according to the user settings for display in the user interface. Commonly used for date/datetime, float/monetary and relational fields.

The QWeb runtime context can also be referenced in the JavaScript web client. Making good use of this requires a good understanding of the web client structure, but we won't go into that here. To reference it, the following identifiers are available in the QWeb expression runtime:

- widget is a reference to the current KanbanRecord() component object, used to render the current record in the Kanban card. It exposes some helper functions for us to use.
- record is a shorthand for widget.record, using dot notation to provide access to the available fields.
- read_only_mode indicates whether the current view is in read mode (not edit mode). It is a short form of widget.view.options.read_only_mode.
- instance is a reference to all web client instances.

It is worth mentioning that some characters cannot be used in expressions, such as the less than sign (<). This is because in the XML standard, these characters have special meanings and should not be used in XML content. The reverse >= is a valid alternative, but the following alternative symbols are usually used for inequality operations:

- lt is less than
- lte is less than or equal to
- gt is greater than
- gte is greater than or equal to

> ℹ️The aforementioned comparison symbols are used only in Odoo and were introduced to solve limitations in the XML format. They are not part of the XML standard.

### String Replacement Dynamic Attributes – t-attf

Our kanban cards use the t-attf QWeb directive to dynamically set a class on the top-level <div> element so that the card can display a color based on the value of the color field. The t-attf- QWeb directive is used for this purpose. The t-attf- directive dynamically generates tag attributes using string replacement. This allows parts of a larger string, such as a URL address or CSS class name, to be dynamically generated.

This directive searches for expression code blocks to run and replaces the result. They are separated by {{ and }} or #{ and }. The content of the code block can be any JavaScript expression and use any variables available in QWeb expressions, such as record and widget. In this example, we also use the specially provided kanban_color() JS function to map index values ​​to class color names.

As a more complex example, we use this directive to dynamically generate the user's color, with red fonts indicating high priority. Replace the corresponding code in the Kanban card below:

```
                                    <li t-attf-class="oe_kanban_text_{{
                                        record.priority.raw_value lt '2'
                                        ? 'black' : 'red'}}">
                                        <field name="user_id" />
                                    </li>
```

This will generate class="oe_kanban_text_red" or class="oe_kanban_text_black" depending on the borrowing priority value. Please note that there is a CSS class of oe_kanban_text_red in the kanban view, but oe_kanban_text_black is only for demonstration and does not actually exist.

> ℹ️Note that the lt symbol used in JavaScript expressions is an escape expression for < and cannot be used in XML.

![Odoo 12 string replacement dynamic attributes](http://alanhou.org/homepage/wp-content/uploads/2019/01/t-attf.jpg)

### Expression dynamic attributes - t-att

t-att- QWeb directive dynamically generates attribute values ​​by running expressions. We use it in our Kanban card to dynamically generate attributes for the <img> tag. The title attribute is dynamically rendered using the following expression:

```
t-att-title="record.member_id.value"
```

The .value field returns the value displayed on the screen. For many-to-one fields, this is usually the name value of the related record. For users, it is the username. After running, the corresponding username will be displayed when the mouse hovers over the image.

When the expression evaluates to false, the attribute will not be rendered. This is important for special HTML attributes, such as checked in input fields, which will be displayed even when there is no attribute value.

![Odoo 12 expression dynamic attributes](http://alanhou.org/homepage/wp-content/uploads/2019/01/t-att.jpg)

### Loop - t-foreach

The same block of HTML code is repeated by looping through it. We can use it to add the avatar of the record's follower. Let's start by rendering only the record's partner ID:

```
<t t-foreach="record.message_partner_ids.raw_value" t-as="rec">
    <t t-esc="rec" />;
</t>
```

The t-foreach directive takes a JavaScript expression to run to iterate over a collection. In most cases, this will be the name of a to-many relationship field. Used with the t-as directive to set the name used to reference the items to be iterated over. The t-esc directive used below runs the provided expression, in this case just the rec variable name, rendering it as transpiled safe HTML.

In the above example, we iterate over the followers stored in the message_partner_ids field. Because the space on the board card is limited, we use the JS slice() function to limit the number of followers displayed, as shown below:

```
t-foreach="record.message_partner_ids.raw_value.slice(0, 3)"
```

The rec variable stores each traversal value, in this case the partner ID. So we can rewrite the loop as:

```
<t t-foreach="record.message_partner_ids.raw_value.slice(0,3)" t-as="rec">
    <img t-att-src="kanban_image('res.partner', 'image_small', rec)"
        class="oe_avatar" width="24" height="24" alt="" />
</t>
```

For example, you can add it next to the user's avatar in the footer on the right. It also contains some help variables, whose names are prefixed with the variable name defined in t_as. In this example, rec is used, so the available help variables are as follows:

- rec_index is the iteration index, starting from 0
- rec_size is the number of elements in the collection
- rec_first is true for the first element of the iterable
- rec_last is true for the last element of the iteration
- rec_even is true if the index is even
- rec_odd is true if the index is odd
- rec_parity is odd or even depending on the current index
- rec_all represents the object to be iterated
- rec_value stores value when iterating over the {key:value} dictionary (rec stores the key name)

For example, you can remove the comma at the end of the ID list using the following code:

```
<t t-foreach="record.message_parter_ids.raw_value.slice(0, 3)"
    t-as="rec">
    <t t-esc="rec" />
    <t t-if="!rec_last">;</t>
</t>
```

![Odoo 12 loop traversal](http://alanhou.org/homepage/wp-content/uploads/2019/01/t-foreach.jpg)

### Conditional judgment - t-if

Our kanban view uses the t-if directive in the card options menu to display different options based on different conditions. The t-if directive requires an expression to be passed in to run in JS when the kanban view is rendered on the client side. The label and its content will only be rendered if the condition evaluates to true. As an example, to display the number of books loaned out only when there is a value for loaned out, add the following code after the request_date field:

```
                                    <t t-if="record.num_books.raw_value gt 0">
                                        <li><field name="num_books" /> books</li>
                                    </t>
```

We use the <t t-if="..."> element so that when the condition is false, the element will not produce any output. When it is true, only the contained <li> element will be rendered for output. Note that the gt symbol is used in the conditional expression instead of > to represent the greater than operator. t-elif and t-else can be used to support else if and else conditional statements, as shown in the following example:

```
                                    <t t-if="record.num_books.raw_value == 0">
                                        <li>No books.</li>
                                    </t>
                                    <t t-elif="record.num_books.raw_value gt 9">
                                        <li>A lot of books!</li>
                                    </t>
                                    <t t-else="">
                                        <li><field name="num_books" /> books.</li>
                                    </t>
```

In Javascript expressions, the operators for AND and OR are && and || respectively. However, XML does not support the & symbol, so we can use the and and or operators to circumvent this problem.

![Odoo 12 QWeb Conditional Decision](http://alanhou.org/homepage/wp-content/uploads/2019/01/t-if.jpg)

### Rendering Values ​​- t-esc and t-raw

We used the <field> element to render the value, but we can also display the field value directly without the <field> tag. The t-esc directive runs the expression and renders it as an escaped HTML value, as shown below:

```
<t t-esc="record.message_partner_ids.raw_value" />
```

In some cases, if you are sure that the source data is safe, you can use t-raw to render the raw value without escaping, as shown in the following example:

```
<t t-raw="record.message_partner_ids.raw_value" />
```

> **Tip:** For security reasons, use of t-raw should be avoided as much as possible. It should be used strictly for outputting HTML data that is specifically prepared to not contain user data, or user data that has HTML special characters explicitly escaped.

### Set a value for a variable - t-set

For more complex logic, we can store the expression results in variables and use them later in the template. This is done with the t-set directive, which sets the variable name, followed by the t-value directive to add the value assigned by the expression calculation. As an example, the following code renders the higher priority color red as in the previous section, but uses the red_or_black variable as the variable used by the CSS class, as shown below:

```
                                    <t t-set="red_or_black"
                                        t-value="record.priority.raw_value gte '2' ? 'oe_kanban_text_red' :''" />
                                    <li t-att-class="red_or_black">
                                        <field name="user_id" />
                                    </li>
```

HTML content can also be assigned to variables, as shown below:

```
<t t-set="calendar_sign">
    <i class="fa fa-calendar" />
</t>
<t t-raw="calendar_sign" />
```

 

![Odoo 12 sets the value of the variable](http://alanhou.org/homepage/wp-content/uploads/2019/01/t-set.jpg)

### Calling and reusing other templates - t-call

QWeb templates can be inserted into other templates as reusable HTML snippets. Instead of repeating the same HTML code blocks, we can design components to form more complex user interface views. Reusable templates are defined in the <templates> tag and identified by the t-name value outside the kanban-box in the top-level element. These templates can be included through t-call, in the current kanban view, elsewhere in the same module, and in other plug-in modules.

The follower avatar list can be separated by a reusable code snippet. Let's rewrite the code by using a sub-template. First, add another template to the XML file. In the <templates> element, after the <t t-name="kanban-box"> node, add the following code:

```
                    <t t-name="follower_avatars">
                        <div>
                            <t t-foreach="record.message_partner_ids.raw_value.slice(0,3)"
                                t-as="rec">
                                <img t-att-src="kanban_image('res.partner', 'image_small', rec)"
                                    class="oe_avatar" width="24" height="24" alt="" />
                            </t>
                        </div>
                    </t>
```

Calling it in the main kanban-box template is straightforward. Change the <div> element containing the for each directive to the following:

```
<t t-call="follower_avatars" />
```

To call templates defined in other plugin modules, similar to views, we need to use the full module.name identifier. For example, the above code snippet can be referenced using the library_checkout.follower_avatars full identifier. The called template and the caller run in the same context, so the variable names in the caller are also available when processing the called template.

A more elegant way to do this is to pass arguments to the calling template, which is done by setting variables in the t-call tag. These are only run and used in the context of the child template, and do not exist in the context of the caller. We will use this method to allow the caller to set the maximum number of follower avatars, rather than hard-coding it in the child template. First, we change the original fixed value of 3 to a variable arg_max:

```
                    <t t-name="follower_avatars">
                        <div>
                            <t t-foreach="record.message_partner_ids.raw_value.slice(0, arg_max)"
                                t-as="rec">
                                <img t-att-src="kanban_image('res.partner', 'image_small', rec)"
                                    class="oe_avatar" width="24" height="24" alt="" />
                            </t>
                        </div>
                    </t>
```

Then define the variable when executing the sub-template call like this:

```
                                    <t t-call="follower_avatars">
                                        <t t-set="arg_max" t-value="3" />
                                    </t>
```

The entire content inside the t-call element is available in child templates via the magic variable 0 (number zero). Instead of using parameter variables, we can also define code snippets and use them in child templates via <t t-raw="0" />. This is particularly useful for creating layouts in a modular way and merging/nesting QWeb templates.

### Dictionary and list dynamic attributes

We have learned the most important QWeb commands, but there are still some that we should know. Let's briefly explain them below.

Earlier we saw t-att-NAME and t-attf-NAME style dynamic tag attributes, in addition to the fixed t-att directive. It accepts a dictionary of key-value pairs or a pair (a list of two elements).

Use the following mapping:

```
<p t-att="{'class': 'oe_bold', 'name': 'Hello'}" />
```

Will generate the following result:

```
<p class="oe_bold" name="Hello" />
```

Use the following pair:

```
<p t-att="['class', 'oe_bold']" />
```

Will generate the following result:

```
<p class="oe_bold" />
```

## Inheritance of Kanban View

Templates used in dashboard views and reports can be inherited in the same general way as views, for example, using XPath expressions, see Chapter 4 [Module Inheritance for Odoo 12 Development](4.md).

A common situation is to use the <field> element as a selector, and then add other elements before or after it. For the kanban view, the same field can be declared multiple times, for example, before the template and inside the template. In this case, the selector will match the first field element and will not modify the field in the template that we want to modify. To avoid this problem, we need to use XPath to ensure that the field in the template is matched, for example:

```
<record id="res_partner_kanban_inherit" model="ir.ui.view">
	<field name="name">Contact Kanban modification</field>
	<field name="model">res.partner</field>
	<field name="inherit_id" ref="base.res_partner_kanban_view" />
	<field name="arch" type="xml">
		<xpath expr="//t[@t-name='kanban-box']//field[@name='display_name']"
			position="before">
			<span>Name:</span>
		</xpath>
	</field>
</record>
```

In the example above, the XPath looks for <field name="display_name"> elements inside a <t t-name="kanban-box"> element. This rule will exclude the same field elements outside of the <templates> section. For more complex XPath expressions, we can use command-line tools to figure out the correct syntax. You may already have the xmllint tool installed on your Linux system (sudo apt install libxml2-utils), which has an --xpath option to perform queries on XML files.

Another option with nicer looking output is the Debian/Ubuntu package libxml-xpath-perl, which comes with an xpath command:

```
$ sudo apt-get install libxml-xpath-perl
$ xpath -e "//record[@id='res_partner_kanban_view']" -e "//field[@name='display_name']]" /path/to/myfile.xml
```

## Custom CSS and JavaScript

As you can see, the kanban views are mostly HTML and make heavy use of CSS classes. We have covered some common CSS classes provided in the standard product, but for best results, we can also add our own CSS to our modules. We will not go into detail here on how to write CSS code, but we will instead explain how to add our own CSS (JavaScript) to our modules. The front-end assets for the backend in Odoo are declared in the assets_backend module. To add front-end assets to a module, you need to extend the module. The XML file for this operation is usually placed in the views/ module subdirectory.

The following is an example of adding a CSS and JavaScript file to the library_checkout module. The corresponding file is library_checkout/views/checkout_kanban_assets.xml:

```
<odoo>
    <template id="assets_backend" inherit_id="web.assets_backend"
        name="Library Checkout Kanban Assets">
        <xpath expr="." position="inside">
            <link rel="stylesheet"
                href="/library_checkout/static/src/css/checkout_kanban.css" />
            <script type="text/javascript"
                src="/library_checkout/static/src/js/checkout_kanban.js">
            </script>
        </xpath>
    </template>
</odoo>
```

As usual, you need to reference it in the __manifest__.py description file. Note that these front-end files are placed in the /static/src subdirectory. This is not a mandatory requirement, but it is a convention.

## Summarize

We learned about Kanban boards and how to create Kanban views to implement them. We also introduced QWeb templates and how to use it to design Kanban cards. QWeb is also the rendering engine for CMS websites, so it is becoming more and more important in the Odoo toolset.

Kanban views can inherit using the same XML syntax used in other views. The XML structure of a Kanban board can be more complex and we often need to use XPath expressions to define the elements to inherit from.

Finally, the advanced kanban view can use its own CSS and JavaScript files. These can be added as module files, which should then be added in the web.assets_backend QWeb template to be included in the client page.

In the next article, we will continue using QWeb, but create custom reports on the server side.

 

☞☞☞Chapter 12 [Odoo 12 Development Report and Server QWeb] (12.md)

 

## Further reading

The following reference materials are supplementary to the topics studied in this article:

- Odoo [official documentation](https://www.odoo.com/documentation/12.0/reference/qweb.html) Introduction to QWeb
- Bootstrap[Style documentation](https://getbootstrap.com/docs/4.1/getting-started/introduction/)
- Font Awesome[icon index](https://fontawesome.com/v4.7.0/icons/)